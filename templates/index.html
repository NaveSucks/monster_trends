{{ define "content" }}
  <h1 class="text-2xl font-bold mb-4">Monster Energy Trends</h1>

  <!-- Header row: Dark mode toggle + Best Price -->
  <div class="flex justify-between items-center mb-4">
    <button id="darkModeToggle" class="px-3 py-1 rounded bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
      🌙
    </button>
    <div id="bestPrice" class="text-4xl font-extrabold text-right">– €</div>
  </div>

  <!-- Timeframe Selector -->
  <div class="flex justify-center space-x-6 mb-4">
    <button onclick="setTimeframe('week')" class="timeframe-btn text-gray-500">W</button>
    <button onclick="setTimeframe('month')" class="timeframe-btn text-gray-500">M</button>
    <button onclick="setTimeframe('year')" class="timeframe-btn text-gray-500">Y</button>
    <button onclick="setTimeframe('all')" class="timeframe-btn text-gray-500">All</button>
  </div>

  <!-- Chart -->
  <canvas id="priceChart" class="w-full h-72"></canvas>

  <!-- Table -->
  <div id="priceTable" class="mt-6"></div>

  <script>
    let chart; 
    let currentTimeframe = "all";

    // Light/Dark mode toggle
    document.addEventListener("DOMContentLoaded", () => {
      const toggleBtn = document.getElementById("darkModeToggle");
      toggleBtn.addEventListener("click", () => {
        document.documentElement.classList.toggle("dark");
        if (document.documentElement.classList.contains("dark")) {
          toggleBtn.textContent = "☀️";
        } else {
          toggleBtn.textContent = "🌙";
        }
      });
    });

    function setTimeframe(tf) {
      currentTimeframe = tf;
      document.querySelectorAll(".timeframe-btn").forEach(btn => {
        btn.classList.remove("text-black", "font-bold", "border-b-2", "border-black", "dark:text-white", "dark:border-white");
        btn.classList.add("text-gray-500");
      });
      event.target.classList.add("text-black", "font-bold", "border-b-2", "border-black", "dark:text-white", "dark:border-white");
      event.target.classList.remove("text-gray-500");
      loadData();
    }

    async function loadData() {
      const endpointMap = {
        week: "/api/offers",
        month: "/api/offers",
        year: "/api/offers",
        all: "/api/offers"
      };
      const url = endpointMap[currentTimeframe] || "/api/offers";
      const res = await fetch(url);
      const data = await res.json();

      // Parse prices
      const parsed = data.map(d => ({
        discounter: d.discounter,
        date: d.date,
        price: parseFloat(d.price.replace("€", "").replace(",", ".").trim())
      }));

      // Group by discounter
      const groups = {};
      parsed.forEach(d => {
        if (!groups[d.discounter]) groups[d.discounter] = [];
        groups[d.discounter].push(d);
      });

      // Extract unique dates (sorted)
      const labels = [...new Set(parsed.map(d => d.date))].sort();

      // Colors
      const colors = ["#22c55e", "#ef4444", "#3b82f6", "#f59e0b", "#8b5cf6"];
      let i = 0;

      // Build datasets
      const datasets = Object.entries(groups).map(([disc, arr]) => {
        const map = {};
        arr.forEach(a => map[a.date] = a.price);
        const offset = (Math.random() - 0.5) * 0.02; // small jitter

        return {
          label: disc,
          data: labels.map(l => (map[l] !== undefined ? map[l] : 1.49) + offset),
          borderColor: colors[i++ % colors.length],
          backgroundColor: "transparent",
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 0,
        };
      });

      // Plugin: right-side labels
      const labelPlugin = {
        id: "endLabels",
        afterDatasetsDraw(chart) {
          const { ctx } = chart;
          ctx.save();
          chart.data.datasets.forEach((ds, idx) => {
            const meta = chart.getDatasetMeta(idx);
            const lastPoint = meta.data[meta.data.length - 1];
            if (!lastPoint) return;
            ctx.fillStyle = ds.borderColor;
            ctx.font = "bold 12px sans-serif";
            ctx.textAlign = "left";
            ctx.textBaseline = "middle";
            ctx.fillText(ds.label, lastPoint.x + 6, lastPoint.y);
          });
          ctx.restore();
        }
      };

      // Plugin: dotted line at 1 €
      const refLinePlugin = {
        id: "refLine",
        afterDraw(chart) {
          const y = chart.scales.y.getPixelForValue(1);
          const { ctx, chartArea: { left, right } } = chart;
          ctx.save();
          ctx.beginPath();
          ctx.setLineDash([5, 5]);
          ctx.moveTo(left, y);
          ctx.lineTo(right, y);
          ctx.strokeStyle = "#9ca3af"; // gray-400
          ctx.lineWidth = 1;
          ctx.stroke();
          ctx.restore();
        }
      };

      // Destroy old chart
      if (chart) chart.destroy();

      // Chart.js
      const ctx = document.getElementById("priceChart").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: false, grid: { display: false, drawBorder: false } },
            y: { display: false, grid: { display: false, drawBorder: false } }
          }
        },
        plugins: [labelPlugin, refLinePlugin]
      });

      // Table + Best Price
      const latestDate = labels[labels.length - 1];
      const todays = Object.keys(groups).map(disc => {
        const entry = groups[disc].find(p => p.date === latestDate);
        return {
          discounter: disc,
          price: entry ? entry.price : 1.49
        };
      });
      const avg = todays.reduce((sum,p) => sum+p.price,0) / todays.length;
      const best = Math.min(...todays.map(p => p.price));
      document.getElementById("bestPrice").innerText = best.toFixed(2) + " €";

      let html = `
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b">
              <th class="text-left py-2">Discounter</th>
              <th class="text-right py-2">Price</th>
            </tr>
          </thead>
          <tbody>
      `;
      todays.forEach(p => {
        const color = p.price < avg ? "text-green-600" : p.price > avg ? "text-red-600" : "text-gray-800";
        html += `
          <tr>
            <td class="py-1">${p.discounter}</td>
            <td class="py-1 text-right font-bold ${color}">${p.price.toFixed(2)} €</td>
          </tr>
        `;
      });
      html += "</tbody></table>";
      document.getElementById("priceTable").innerHTML = html;
    }

    loadData();
    // Default active button
    document.querySelectorAll(".timeframe-btn")[3].classList.add("text-black", "font-bold", "border-b-2", "border-black");
    document.querySelectorAll(".timeframe-btn")[3].classList.remove("text-gray-500");
  </script>
{{ end }}

{{ template "layout.html" . }}
