{{ define "content" }}
  <h1 class="text-2xl font-bold mb-4">Monster Energy Trends</h1>

  <!-- Chart -->
  <canvas id="priceChart" class="w-full h-64"></canvas>

  <!-- Table -->
  <div id="priceTable" class="mt-6"></div>

  <script>
    async function loadData() {
      const res = await fetch("/api/offers");
      const data = await res.json();

      // Parse prices -> convert "0,88 €" to float
      const parsed = data.map(d => ({
        discounter: d.discounter,
        date: d.date,
        price: parseFloat(d.price.replace("€", "").replace(",", ".").trim())
      }));

      // Group by discounter
      const groups = {};
      parsed.forEach(d => {
        if (!groups[d.discounter]) groups[d.discounter] = [];
        groups[d.discounter].push(d);
      });

      // Sort by date inside each group
      Object.values(groups).forEach(arr => arr.sort((a,b) => a.date.localeCompare(b.date)));

      // Extract unique dates
      const labels = [...new Set(parsed.map(d => d.date))];

      // Chart datasets
      const colors = ["#22c55e", "#ef4444", "#3b82f6", "#f59e0b", "#8b5cf6"];
      let i = 0;
      const datasets = Object.entries(groups).map(([disc, arr]) => {
        const map = {};
        arr.forEach(a => map[a.date] = a.price);
        return {
          label: disc,
          data: labels.map(l => map[l] || null),
          borderColor: colors[i++ % colors.length],
          backgroundColor: "transparent",
          tension: 0.3,
          borderWidth: 2,
        };
      });

      // Chart.js
      const ctx = document.getElementById("priceChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: false, ticks: { callback: v => v + " €" } }
          }
        }
      });

      // Table
      const latestDate = labels[labels.length - 1];
      const todays = parsed.filter(p => p.date === latestDate);
      const avg = todays.reduce((sum,p) => sum+p.price,0) / todays.length;

      let html = `
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b">
              <th class="text-left py-2">Discounter</th>
              <th class="text-right py-2">Price</th>
            </tr>
          </thead>
          <tbody>
      `;
      todays.forEach(p => {
        const color = p.price < avg ? "text-green-600" : p.price > avg ? "text-red-600" : "text-gray-800";
        html += `
          <tr>
            <td class="py-1">${p.discounter}</td>
            <td class="py-1 text-right font-bold ${color}">${p.price.toFixed(2)} €</td>
          </tr>
        `;
      });
      html += "</tbody></table>";
      document.getElementById("priceTable").innerHTML = html;
    }

    loadData();
  </script>
{{ end }}

{{ template "layout.html" . }}